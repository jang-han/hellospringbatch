# プロジェクトの説明

このプロジェクトは、さまざまな CSV ファイルを処理し、データベースに保存し、エラー処理とログ管理を行う Spring Batch ベースのバッチアプリケーションです。

---

## システム環境変数一覧

| 環境変数名             | データ形式 | 説明                                             | 例                                                |
| ---------------------- | ---------- | ------------------------------------------------ | ------------------------------------------------- |
| `CSV_INPUT_DIR`        | `String`   | CSV ファイルの入力ディレクトリパス               | `/path/to/csv/input`                              |
| `CSV_BACKUP_DIR`       | `String`   | バックアップディレクトリパス                     | `/path/to/csv/backup`                             |
| `CSV_OUTPUT_OK_DIR`    | `String`   | 正常に処理されたファイルの保存先ディレクトリパス | `/path/to/csv/output/ok`                          |
| `CSV_OUTPUT_NG_DIR`    | `String`   | エラーファイルの保存先ディレクトリパス           | `/path/to/csv/output/ng`                          |
| `LOG_DIR`              | `String`   | ログファイル保存ディレクトリパス                 | `/path/to/log`                                    |
| `MYSQL_USER_INFO_DB`   | `String`   | MySQL データベース URL (UserInfo 用)             | `jdbc:mysql://localhost:3306/userinfo`            |
| `POSTGRES_MED_OPIN_DB` | `String`   | PostgreSQL データベース URL (MedicalOpinion 用)  | `jdbc:postgresql://localhost:5432/medicalopinion` |
| `LOG_FILE_NAME`        | `String`   | メインログファイル名                             | `hellolog`                                        |
| `DATA_ERROR_FILE_NAME` | `String`   | データエラーログファイル名                       | `dataErrorLog`                                    |
| `MAX_LOG_HISTORY`      | `Integer`  | ログの最大保存期間（日単位）                     | `365`                                             |
| `TASK_START_DELAY`     | `Long`     | タスク開始前の遅延時間（ミリ秒）                 | `1000`                                            |

---

## エラーハンドリング一覧

| エラーコード | 発生タスク                   | 例外タイプ                       | 説明                                           | エラーメッセージ例                                                       | 処理方法                                                             |
| ------------ | ---------------------------- | -------------------------------- | ---------------------------------------------- | ------------------------------------------------------------------------ | -------------------------------------------------------------------- |
| `E001`       | `DeleteOldFilesTasklet`      | `IOException`                    | ファイル削除失敗時                             | "古いファイルを削除できません: <ファイルパス>"                           | 失敗したファイルパスをログに記録し、次のファイルを処理続行           |
| `E002`       | `CsvFileCheckAndMoveTasklet` | `IOException`                    | ファイル移動失敗時                             | "CSV ファイルをバックアップディレクトリに移動できません: <ファイルパス>" | 失敗したファイルパスを記録し、次のファイルを処理続行                 |
| `E003`       | `CsvFileCheckAndMoveTasklet` | `NullPointerException`           | ディレクトリまたはファイルリストが null の場合 | "CSV 入力ディレクトリが存在しないか、ディレクトリではありません"         | エラーログを記録後、次のタスクに進む                                 |
| `E004`       | `CsvCompareAndWriteTasklet`  | `IOException`                    | CSV ファイルの読み取り中にエラー発生           | "CSV ファイル読み取りエラー: <ファイルパス>"                             | エラーログを記録し、他のファイルを正常処理                           |
| `E005`       | `CsvCompareAndWriteTasklet`  | `ArrayIndexOutOfBoundsException` | CSV ファイルの必須データ不足                   | "CSV データ形式エラー - フィールドが不足しています: <データ内容>"        | NG ログにエラーデータを記録し、次の行を処理続行                      |
| `E006`       | `CsvToPostgresTasklet`       | `NumberFormatException`          | 身長/体重の数値変換失敗時                      | "数値変換エラー - 身長または体重の形式が不正です: <値>"                  | NG ログに変換失敗内容を記録し、他の行を正常処理                      |
| `E007`       | `CsvToPostgresTasklet`       | `IOException`                    | OK ファイル読み取り中にエラー発生              | "OK ファイル読み取りエラー: <ファイルパス>"                              | エラーログを記録し、他のファイルを正常処理                           |
| `E008`       | `CsvToPostgresTasklet`       | `RuntimeException`               | PostgreSQL へのデータ保存失敗                  | "データベースエラー - レコードの追加/更新失敗: <データ内容>"             | エラーログを記録後トランザクションをロールバックし、次の行を処理続行 |

---

## ログファイル設定と管理

### ログファイル種類

1. **メインログファイル**: `hellolog.log`
   - 全ての実行情報およびエラーを記録します。
2. **データエラーログファイル**: `dataErrorLog.log`
   - データ関連のエラー（NG データ）を別途記録します。

### ログ保持ポリシー

- ログファイルは 1 年間（365 日）保持され、その後自動的に削除されます。

---

## 実行方法

1. **環境変数の設定**: `application.properties`または環境変数で各パスと DB 情報を設定します。
2. **Spring Batch の実行**: `SpringApplication.run(Application.class, args);`を実行してバッチを開始します。
3. **ログの確認**: 設定されたログファイルで実行結果およびエラー内容を確認できます。

---

本プロジェクトは、CSV ファイルの処理とデータベース保存作業を安全に実行できるよう設計されており、環境変数とエラーハンドリングにより安定性と拡張性を提供します。

## 処理フロー

### DeleteOldFilesTasklet フローチャート

![DeleteOldFilesTasklet フローチャート](docs/flowcharts/DeleteOldFilesTasklet.png)

### CsvFileCheckAndMoveTasklet フローチャート

![CsvFileCheckAndMoveTasklet フローチャート](docs/flowcharts/CsvFileCheckAndMoveTasklet.png)

### CsvCompareAndWriteTasklet フローチャート

![CsvCompareAndWriteTasklet フローチャート](docs/flowcharts/CsvCompareAndWriteTasklet.png)

### CsvToPostgresTasklet フローチャート

![CsvToPostgresTasklet フローチャート](docs/flowcharts/CsvToPostgresTasklet.png)

スタート
│
├──> 削除対象の日付を取得 (1 年前)
│
├──> 対象ディレクトリのリスト取得
│
├──> 各ディレクトリを処理
│ ├── ディレクトリ存在確認
│ │ ├── 存在しない場合：エラーログ出力
│ │ └── 存在する場合：
│ │
│ ├──> CSV および END ファイルのリスト取得
│ │ ├── ファイルが存在しない場合：次のディレクトリへ
│ │ └── 存在する場合：
│ │
│ ├──> 各ファイルを処理
│ │ ├── 最終更新日を取得
│ │ ├── 更新日が 1 年前より前か確認
│ │ │ ├── はい：ファイル削除
│ │ │ └── いいえ：何もしない
│ │ │
│ │ └──> 削除成功または失敗のログ出力
│
└──> 完了ログ出力

흐름 설명
スタート: 태스크가 시작되며, 삭제할 기준 날짜(1년 전)를 가져옵니다.
対象ディレクトリリスト取得: 삭제할 디렉토리 목록을 가져옵니다.
ディレクトリ処理: 각 디렉토리를 처리합니다.
디렉토리가 존재하지 않으면 에러 로그를 남깁니다.
ファイルリスト取得: 각 디렉토리에서 CSV 및 END 파일 목록을 가져옵니다.
파일이 존재하지 않으면 다음 디렉토리로 넘어갑니다.
ファイル処理: 각 파일의 최종 수정일을 확인하고, 1년보다 이전이면 삭제합니다.
삭제 성공 또는 실패에 대한 로그를 남깁니다.
完了: 모든 처리가 끝나면 완료 로그를 남깁니다

スタート
│
├──> 入力ディレクトリのパス取得
│
├──> バックアップディレクトリのパス取得
│
├──> 入力ディレクトリ存在確認
│ ├── 存在しない場合：エラーログ出力
│ └── 存在する場合：
│
├──> CSV ファイルのリスト取得
│ └── CSV ファイルが存在するか確認
│ ├── 存在しない場合：エラーログ出力
│ └── 存在する場合：
│
├──> バックアップディレクトリの作成（存在しない場合）
│
├──> 各 CSV ファイルをバックアップディレクトリに移動
│ ├── 移動成功：成功ログ記録
│ └── 移動失敗：エラーログ記録
│
└──> 完了ログ出力

흐름 설명
スタート: 태스크가 시작되며, 입력 디렉토리와 백업 디렉토리의 경로를 가져옵니다.
ディレクトリ存在確認: 입력 디렉토리가 존재하지 않으면 에러 로그를 남깁니다. 존재하면 CSV 파일 목록을 가져옵니다.
CSV ファイルリスト取得: CSV 파일이 존재하는지 확인하고, 존재하지 않으면 에러 로그를 남깁니다.
バックアップディレクトリ作成: 백업 디렉토리가 존재하지 않으면 생성합니다.
CSV ファイル移動: 각 CSV 파일을 백업 디렉토리로 이동시키고, 성공 여부에 따라 로그를 남깁니다.
完了: 모든 처리가 끝나면 완료 로그를 남깁니다.

スタート
│
├──> 移動したファイルのリスト取得
│
├──> MySQL のユーザー情報リストを取得
│
├──> 今日の日付を取得
│
├──> OK ファイルおよび NG ファイルのパス設定
│
├──> OK ファイルのヘッダー追加
│
├──> NG ファイルのヘッダー追加
│
├──> 各 CSV ファイルを処理
│ ├── CSV ファイルが存在するか確認
│ │ ├── 存在しない場合：次のファイルへ
│ │ └── 存在する場合：
│ │
│ ├──> 各行を処理
│ │ ├── 不正な行：NG ファイルに書き込み、ログ記録
│ │ ├── 高さまたは体重がない場合：NG ファイルに書き込み、ログ記録
│ │ └── ユーザー情報と一致する場合：
│ │ ├── OK ファイルに書き込み
│ │ └── 一致しない場合：NG ファイルに書き込み
│
├──> 終了ファイルの作成
│
└──> 完了ログ出力

흐름 설명
スタート: 태스크가 시작되며, 이동된 파일 목록을 가져옵니다.
ユーザー情報リスト取得: MySQL 데이터베이스에서 사용자 정보를 가져옵니다.
日付取得: 오늘의 날짜를 가져옵니다.
ファイルパス設定: OK 및 NG 파일의 경로를 설정합니다.
ヘッダー追加: OK 및 NG 파일에 헤더를 추가합니다.
CSV ファイル処理: 각 CSV 파일을 처리합니다.
파일이 존재하지 않으면 다음 파일로 넘어갑니다.
각 행을 처리하며, 불법적인 형식의 행은 NG 파일에 기록합니다.
키나 몸무게 값이 없으면 NG 파일에 기록하고, 사용자 정보가 일치하면 OK 파일에 기록합니다.
終了ファイル作成: 종료 파일을 생성합니다.
完了: 모든 처리가 끝나면 완료 로그를 남깁니다.

スタート
│
├──> OK ファイルのパスを取得
│
├──> OK ファイルの存在確認
│ ├── 存在しない場合：終了ログ出力
│ └── 存在する場合：
│
├──> OK ファイルを読み取り
│ ├── 最初の行はヘッダーとしてスキップ
│ ├── 各行を処理
│ │ ├── 不正なデータ形式：エラーログ出力
│ │ └── データを挿入または更新
│ │ ├── 同じ名前とメールが存在する場合：データ更新
│ │ └── 存在しない場合：新しいレコード追加
│
└──> 完了ログ出力

흐름 설명
スタート: 태스크가 시작되며, OK 파일의 경로를 가져옵니다.
ファイル存在確認: OK 파일이 존재하는지 확인합니다.
존재하지 않으면 종료 로그를 남깁니다.
ファイル読み取り: OK 파일을 읽어 들이며, 첫 번째 줄(헤더)은 스킵합니다.
行を処理: 각 행을 처리합니다.
불법적인 형식의 행은 에러 로그를 남깁니다.
데이터가 있는 경우:
동일한 이름과 이메일이 존재하면 데이터를 업데이트합니다.
존재하지 않으면 새 레코드를 추가합니다.
完了: 모든 처리가 끝나면 완료 로그를 남깁니다.
